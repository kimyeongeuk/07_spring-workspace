<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">


	<resultMap type="boardDto" id="boardResultMap">
		<result column="BOARD_NO" property="boardNo"/>
		<result column="BOARD_TITLE" property="boardTitle"/>
		<result column="user_id" property="boardWriter"/>
		<result column="BOARD_CONTENT" property="boardContent"/>
		<result column="COUNT" property="count"/>
		<result column="REGIST_DATE" property="registDate"/>
		<result column="status" property="status" />
		<result column="attach_count" property="attachCount" />

		<!-- has many 관계(한 객체에 여러객체(List)를 가지고있는)일 경우 (collection 사용하기) -->
		<!-- case1) List내의 객체를 매핑시켜주는 resultMap이 따로 존해하지 않을 경우 -->
		
		<!-- 
		<collection ofType="AttachDto" property="attachList">
			<result column="file_no" property="fileNo"/>
			<result column="file_path" property="filePath"/>
			<result column="filesystem_name" property="filesystemName"/>
			<result column="original_Name" property="originalName"/>
		</collection>
		 -->
		 
		 <!-- case 2) List내의 객체를 매핑시켜주는 resultMap이 따로 존재할 경우 -->
		<collection resultMap="attachResultMap" property="attachList"/>
	</resultMap>
		
	<resultMap type="AttachDto" id="attachResultMap">
			<result column="file_no" property="fileNo"/>
			<result column="file_path" property="filePath"/>
			<result column="filesystem_name" property="filesystemName"/>
			<result column="original_Name" property="originalName"/>
	</resultMap>

	<!-- 혹시라도 has a 관계(1:1)일 경우 => collection 대신에 association 으로 사용 -->

	<select id="selectBoardListCount" resultType="_int">
		select
						count(*)
			from	board
		 where	status = 'Y'
	
	</select>

	<select id="selectBoardList" resultMap="boardResultMap">
		select
		        board_no
		     ,  board_title
		     ,  user_id
		     ,  count
		     ,  to_char(regist_date,'YYYY-MM-DD') as regist_date
		     ,  (
		            select count(*)
		              from attachment
		             where ref_type = 'B'
		               and ref_no = b.board_no
		        ) as attach_count
		  from  board b
		  join  member on (user_no = board_writer)
		 where  b.status = 'Y'
		 order by board_no desc
	</select>
	
	
	<select id="selectSearchListCount" resultType="_int">
		select
						count(*)
			from	board b
			join	member on (user_no = board_writer)
		 where	b.status = 'Y'	
		 	 and	${condition} like '%' || #{keyword} || '%'
	</select>
	
	<select id="selectSearchList" resultMap="boardResultMap">
		select
		        board_no
		     ,  board_title
		     ,  user_id
		     ,  count
		     ,  to_char(regist_date,'YYYY-MM-DD') as regist_date
		     ,  (
		            select count(*)
		              from attachment
		             where ref_type = 'B'
		               and ref_no = b.board_no
		        ) as attach_count
		  from  board b
		  join  member on (user_no = board_writer)
		 where  b.status = 'Y'
		 	 and	${condition} like '%' || #{keyword} || '%'
		 order by board_no desc	
	</select>

	<insert id="insertBoard">
		insert
			into	board
			(
				BOARD_NO
			,	BOARD_TITLE
			,	BOARD_WRITER
			, BOARD_CONTENT
			)
			values
			(
				seq_bno.nextval
			,	#{boardTitle}
			,	#{boardWriter}
			, #{boardContent}
			)
	
	</insert>


	<insert id="insertAttach">
		insert
			into attachment
			(
				FILE_NO
			,	FILE_PATH
			,	FILESYSTEM_NAME
			,	ORIGINAL_NAME
			,	REF_TYPE
			,	REF_NO
			)
			values
			(
				seq_ano.nextval
			,	#{filePath}
			,	#{filesystemName}
			, #{originalName}
			, #{refType}
			, seq_bno.currval
			)
	
	
	</insert>


	<select id="selectBoard" resultMap="boardResultMap">
		select
		        board_no
		     ,  board_title
		     ,  board_content
		     ,  user_id
		     ,  to_char(regist_date,'YYYY-MM-DD') as regist_date
		     ,  file_no
		     ,  file_path
		     ,  filesystem_name
		     ,  original_name
		  from  board b
		  join  member on (user_no = board_writer)
		  full join  attachment on (ref_type = 'B' and ref_no = board_no)
		 where  b.status = 'Y'
		   and  board_no = #{boardNo}
	</select>









</mapper>
